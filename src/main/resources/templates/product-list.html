<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Product List</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
<div class="container mt-3">
    <form id="searchForm" th:action="@{/product}" th:method="GET">
        <div class="row input-group mb-3">
            <div class="col-1"></div>
            <div class="col-2 mt-1">
                <label class="">Mã sản phẩm</label>
            </div>
            <div class="col-6">
                <input class="form-control border-dark shadow-none" type="text" id="productCode" name="productCode" placeholder="Nhập mã sản phẩm" th:value = "${productCode}">
            </div>
        </div>

        <div class="row input-group">
            <div class="col-1"></div>
            <div class="col-2 mt-1">
                <label class="">Tên sản phẩm</label>
            </div>
            <div class="col-6">
                <input class="form-control border-dark shadow-none" type="text" id="productName" name="productName" placeholder="Nhập tên sản phẩm" th:value = "${productName}">
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-3"></div>
            <div class="col-3">
                <div class="row">
                    <div class="col-6">
                        <button type="submit" class="btn btn-primary" onclick="saveSearchValues()"> Tìm kiếm</button>
                    </div>
                    <div class="col-6">
                        <button type="reset" class="btn btn-primary" onclick="clearLocalStorage()"> Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
	<div class= "row">
		<a href="/product/insert" class="text-decoration-none text-light">
		<button class="btn btn-primary " type="button"> Thêm mới</button>
		</a>
	</div>
	<table class="table table-hover mt-3">
        <thead>
        <tr>
            <th scope="col" class="text-center">Số thứ tự</th>
            <th scope="col">Mã sản phẩm</th>
            <th scope="col">Tên sản phẩm</th>
            <th th:if = "${isAdmin}" scope="col">Giá mua</th>
            <th scope="col">Giá bán</th>
            <th scope="col" class="text-center">Số lượng tồn kho</th>
            <th th:if = "${isAdmin}" scope="col" >Hành động</th>
        </tr>
        </thead>
        <tbody>
		    <tr th:if = "${products.size() != 0}" th:each="prod, index : ${products}">
		        <th scope="row" class="text-center" th:text=" ${index.index + 1 + (currentPage - 1) *3}"></th>
		        <td th:text="${prod.productCode}"></td>
		        <td th:text="${prod.productName}"></td>
				<td th:if = "${isAdmin}" th:text="${#numbers.formatDecimal(prod.purchasePrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
				<td th:text="${#numbers.formatDecimal(prod.salePrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
		        <td class="text-center" th:text="${prod.inventoryQuantity}"></td>
		        <td th:if = "${isAdmin}">
		        	<a th:href="@{'/product/update/' + ${prod.productId}}" class="text-decoration-none text-light">
		        		<button class="btn btn-primary">Chỉnh sửa</button>
	        		</a>
			        <a th:href="@{'/product/delete/' + ${prod.productId}}" class="text-decoration-none text-light" >
			        	<button class="btn btn-primary delete-btn" onclick="return confirm('Bạn có muốn xóa sản phẩm này không?')">Xóa</button>
		        	</a>
		        </td>
		    </tr>
		    <tr th:if= "${products.size() == 0}" >
		    	<td colspan = "7" class="text-center"> Không tìm thấy sản phẩm!</td>
		    </tr>
		</tbody>
    </table>
    
    <nav th:if = "${products.size() != 0}" aria-label="Page navigation example " class="d-flex justify-content-center">
        <ul class="pagination">
        	<li class="page-item" th:if="${currentPage != 1}" >
		      <a th:href="@{'/product?page=' +${currentPage - 1} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}" 
		      	class="page-link" aria-label="Previous">
		        <span aria-hidden="true">&laquo;</span>
		      </a>
   			 </li>
   			 <th:block th:if="${totalPage <= 8}" th:each="i : ${#numbers.sequence(1, totalPage)}" >
   			 	<li class="page-item" th:if="${i != currentPage}">
	                <a class="page-link" aria-current="page" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
            	</li>
            	<li class="page-item active" th:if="${i == currentPage}">
	                <a class="page-link" aria-current="page" href="#" th:text="${i}">
	               	</a>
            	</li>
   			 </th:block>

   			 <th:block th:if="${totalPage > 8 and currentPage < 5}" th:each="i : ${#numbers.sequence(1, totalPage)}">
   			 	<li class="page-item" th:classappend="${i == currentPage ? 'active ' : '' }">
	               	<a  th:if="${i < 6}"
	                	class="page-link" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
	               	<div th:if="${i == totalPage-1 }">...</div>
	               	<a  th:if="${i == totalPage}"
	                	class="page-link" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
            	</li>
   			 </th:block>

			<th:block th:if="${totalPage > 8 and currentPage > totalPage - 4 }" th:each="i : ${#numbers.sequence(1, totalPage)}">
				<li class="page-item" th:classappend="${i == currentPage ? 'active ' : '' }">
	               	<a  th:if="${i == 1}"
	                	class="page-link" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
	               	<div th:if="${i == 2 }">...</div>
	               	<a  th:if="${i > totalPage-5}"
	                	class="page-link" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
            	</li>
			</th:block>
            
            <th:block th:if="${totalPage > 8 and currentPage < totalPage - 3 and currentPage > 4 }" th:each="i : ${#numbers.sequence(1, totalPage)}">
            	<li  class="page-item" th:classappend="${i == currentPage ? 'active ' : '' }">
	               	<a  th:if="${i == 1}"
	                	class="page-link" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
	               	<div th:if="${i == 2 }">...</div>
	               	<a  th:if="${ i == currentPage -1 }"
	                	class="page-link" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
	               	<a  th:if="${ i == currentPage }"
	                	class="page-link" 
	                	href="s"
	                 	th:text="${i}">
	               	</a>
	               	<a  th:if="${i == currentPage + 1 }"
	                	class="page-link" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
	               	<div th:if="${i == totalPage -1 }">...</div>
	               	<a  th:if="${i == totalPage}"
	                	class="page-link" 
	                	th:href="@{'/product?page=' +${i} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}"
	                 	th:text="${i}">
	               	</a>
            	</li>
            </th:block>
            
            <li th:if="${currentPage != totalPage}">
        		<a  th:href="@{'/product?page=' +${currentPage + 1} + ${ productCode != '' ? '&productCode=' + productCode : '' } + ${ productName != '' ? '&productName=' + productName : '' }}" 
        			class="page-link" aria-label="Next">
        			<span aria-hidden="true">&raquo;</span>
        		</a>
        	</li>
        </ul>
    </nav>
</div>
<script th:inline="javascript">
	/*<![CDATA[*/
	var message = /*[[${message}]]*/ '';
	
	if (message) {
	    alert(message);
	}
	/*]]>*/
</script>

<script>
    // Hàm lấy giá trị của currentPage từ URL
    function getCurrentPageFromURL() {
        // Lấy query params từ URL
        var urlParams = new URLSearchParams(window.location.search);
        
        // Lấy giá trị của tham số "page" từ query params
        var currentPage = urlParams.get('page');
        
        // Trả về giá trị của currentPage hoặc mặc định là 1 nếu không có
        return currentPage ? parseInt(currentPage) : 1;
    }

    // Function lưu giá trị vào localStorage
    function saveSearchValues() {
        var currentPage = getCurrentPageFromURL(); // Lấy giá trị của currentPage từ URL
        var productCode = document.getElementById('productCode').value;
        var productName = document.getElementById('productName').value;

        // Lưu giá trị vào localStorage
        localStorage.setItem('currentPage', currentPage);
        localStorage.setItem('productCode', productCode);
        localStorage.setItem('productName', productName);
    }
 // Khi trang được load, lấy giá trị của currentPage từ URL và lưu vào localStorage
    window.onload = function() {
        var currentPage = getCurrentPageFromURL();
        localStorage.setItem('currentPage', currentPage);
    };	
 // Function xóa hết dữ liệu trong localStorage
    function clearLocalStorage() {
        localStorage.clear();
        window.location.href = '/product';
    }
</script>


<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>